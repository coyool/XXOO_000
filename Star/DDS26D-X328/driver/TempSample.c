
/*******************************************************************
* Copyright (c) 2013,深圳市思达仪表有限公司 
* All rights reserved. 
* 
* 文件名称：TempSample.h 
* 文件标识：见配置管理计划书 
* 摘要：温度采样

* 当前版本：1.0.0 
* 作者：张玉清
* 完成日期：20131107
*******************************************************************/
#include "Include.h"

/*--------------------全局常量定义---------------------*/
const uint32 s_ResVal[] =
{
    193280, 188110, 182950, 178080, 173220, 168630, 164050, 159740, 155430, 151360,     //-40
    147300, 143470, 139650, 136040, 132440, 129040, 125650, 122440, 119240, 116220,     //-35
    113200, 110350, 107500, 104810, 102120, 99570,  97030,  94630,  92230,  89957,      //-30
    87687,  85540,  83390,  81364,  79340,  77415,  75500,  73678,  71860,  70143,      //-25
    68424,  66796,  65170,  63628,  62090,  60629,  59170,  57788,  56410,  55096,      //-20
    53790,  52545,  51300,  50128,  48950,  47836,  46720,  45662,  44600,  43600,      //-15
    42600,  41644,  40690,  39787,  38883,  38024,  37165,  36350,  35534,  34759,      //-10
    33984,  33248,  32511,  31811,  31111,  30445,  29779,  29145,  28511,  27908,      //-5
    27305,  26731,  26157,  25611,  25064,  24543,  24022,  23526,  23030,  22557,      //0
    22084,  21633,  21182,  20751,  20321,  19911,  19500,  19109,  18717,  18343,      //5
    17969,  17612,  17255,  16914,  16573,  16247,  15922,  15610,  15299,  15001,      //10
    14704,  14419,  14135,  13862,  13590,  13330,  13070,  12821,  12572,  12333,      //15
    12095,  11867,  11639,  11421,  11202,  10993,  10784,  10584,  10384,  10192,      //20
    10000,  9816,   9632,   9456,   9280,   9111,   8942,   8781,   8619,   8464,       //25
    8308,   8160,   8011,   7868,   7725,   7588,   7451,   7320,   7189,   7062,       //30
    6936,   6815,   6694,   6578,   6462,   6350,   6239,   6132,   6024,   5922,       //35
    5819,   5720,   5621,   5526,   5431,   5340,   5248,   5161,   5073,   4988,       //40
    4904,   4823,   4742,   4664,   4586,   4511,   4436,   4364,   4291,   4222,       //45
    4152,   4086,   4019,   3954,   3890,   3828,   3766,   3706,   3647,   3589,       //50
    3532,   3476,   3421,   3367,   3314,   3263,   3211,   3162,   3112,   3064,       //55
    3016,   2970,   2924,   2880,   2835,   2793,   2750,   2708,   2667,   2627,       //60
    2587,   2548,   2510,   2473,   2436,   2400,   2364,   2329,   2294,   2261,       //65
    2227,   2195,   2162,   2131,   2100,   2070,   2040,   2010,   1981,   1953,       //70
    1925,   1897,   1870,   1843,   1817,   1791,   1766,   1741,   1716,   1692,       //75
    1669,   1645,   1622,   1600,   1577,   1558,   1534,   1513,   1492,   1472,       //80
    1451,   1432,   1412,   1393,   1374,   1355,   1337,   1319,   1301,   1284,       //85
    1266,   1249,   1232,   1216,   1200,   1184,   1169,   1154,   1139,   1125,       //90
    1111,   1097,   1084,   1071,   1058,   1046,   1034,   1022,   1011,   1000,  990, //95--100
};

/*--------------------全局变量定义---------------------*/


/*--------------------内部函数申明-------------------------*/

/*********************************************************** 
函数功能：获取温度
入口参数：
*pCurTemp温度存放指针，1位小数xx.x
avg 1-均值 0-瞬时值

出口参数：succ(1=succ;0=fail)
备注说明: //对GND分压电阻47k,对VCC分压电阻47k
		  //根据TTC3A103F34D1EY温度曲线s_ResVal计算当前温度，分辨率0.1度
***********************************************************/
uint8 TempGet(int16 *pCurTemp, uint8 avg)
{
    uint16_t total;
    uint32_t CurRes;
    uint16_t index1,index2,index3;
    uint32_t res_div[6] = {0}, gap;

	//获取当前NTC阻值
    if(avg)
    {
        CurRes = (DRV_ADC_GetAvg(0)-DRV_ADC_GetAvg(1))*(uint32)47000/DRV_ADC_GetAvg(1);	//对GND分压电阻47k,对VCC分压电阻47k,
    }
    else
    {
        CurRes = (DRV_ADC_Get(0)-DRV_ADC_Get(1))*(uint32)47000/DRV_ADC_Get(1);	//对GND分压电阻47k,对VCC分压电阻47k,
    }

	//查当前温度
	//根据TTC3A103F34D1EY温度曲线s_ResVal计算当前温度，分辨率0.1度
	if(CurRes>s_ResVal[0])
	{
	  *pCurTemp = -400;
	  return TRUE;
	}
	total = (200+80) + 1;
	for(index1 = 0; index1<total; index1++)
	{
		if(IsInRange(CurRes, s_ResVal[index1+1], s_ResVal[index1]))
		{
			gap = (s_ResVal[index1]-s_ResVal[index1+1])/5;
			for(index2=0; index2<6; index2++)
			{
				res_div[index2] = s_ResVal[index1+1] + gap*index2;
				if(index2 == 5) res_div[index2] = s_ResVal[index1];
			}
			for(index2=0; index2<5; index2++)
			{
				if(IsInRange(CurRes, res_div[index2], res_div[index2+1]))
				{
					if(CurRes - res_div[index2] < res_div[index2+1] - CurRes)
						index3 = index2;
					else
						index3 = index2+1;
					*pCurTemp = ((index1+1-80)*5 - index3*1);
					return TRUE;
				}
				
			}
		}
	}
	*pCurTemp = 250;
	return FALSE;
}

/*********************************************************** 
函数功能：温度采样test
入口参数：
出口参数：
备注说明:
***********************************************************/
void TempTest(void)
{
  int16 temperature;
  
	TempGet(&temperature, 1);
	//printf( "temperature:%d\n\r", temperature);
}

